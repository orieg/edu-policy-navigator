# Chat Widget Implementation Plan

**Goal:** Implement a small, expandable chat widget that integrates with the in-browser KuzuDB/WebLLM RAG backend to provide policy information for a selected school district, drawing insights from best practices like those detailed at [KuzuDB Blog: In-Browser Graph RAG](https://blog.kuzudb.com/post/kuzu-wasm-rag/).

**Assumptions:**
*   Core KuzuDB/WebLLM handlers (`kuzudbHandler.ts`, `webllmHandler.ts`), the `ragController.ts` (which implements the 3-step Graph RAG: Text-to-Cypher, Cypher-to-Context, Context-to-Answer), and state management for `currentDistrictId`, KuzuDB instances, and the WebLLM engine are implemented or planned as per `IMPLEMENTATION.md` (Phase 4.3). The `ragController` is expected to handle schema inclusion in prompts for Text-to-Cypher.
*   **KuzuDB Data Loading:** Unlike the dynamic CSV ingestion shown in the referenced KuzuDB blog post, this project utilizes **pre-built KuzuDB database files (`.db`)** for each district (or a main one), generated by the backend data pipeline. The `kuzudbHandler.ts` is responsible for loading the appropriate pre-built `.db` file for the selected district into KuzuDB-Wasm on the client-side.
*   A testing script is available via `pnpm run test`.

**Guidance:**
 * When not sure of current implementation, review code in `src/`.
 * Never assume blindly, always confirm current implementation before changing or adding new code.
 * Do not add new framework unless explicitly asked for it.
 * Use our global CSS and shared color palette.

---

**Progress Log / Current Status:**

*   **Initial Setup & Planning:** Established plan, created this file.
*   **Widget UI (`ExpandableChatWidget.astro`, `ChatWindow.astro`):**
    *   Created components, integrated into `BaseLayout.astro`.
    *   Styled using plain CSS and global variables.
    *   Implemented expand/collapse, parent-child communication (custom events, exposed methods).
    *   Ensured `ChatWindow.astro` handles various message types and can control input state.
    *   Troubleshot styling, JS syntax, and communication issues.
    *   Refined initialization messages for better UX (single loading message, updates for WebLLM progress, distinct final system/AI messages).
*   **RAG Backend Handlers (Phase 2.5 initiated):**
    *   **`kuzudbHandler.ts` (Task 6 - In Progress/Largely Complete):**
        *   Created `src/lib/kuzudbHandler.ts`, installed `kuzu-wasm`.
        *   Configured `vite-plugin-static-copy` for worker script.
        *   Implemented handler class, refined API usage (`executeQuery` takes `districtId`).
        *   Added `isReady()` method.
        *   Created `src/kuzu-wasm.d.ts` for basic types.
    *   **`webllmHandler.ts` (Task 7 - In Progress/Largely Complete):**
        *   Created `src/lib/webllmHandler.ts`, installed `@mlc-ai/web-llm`.
        *   Refactored based on `MLCEngine` and `engine.chat.completions.create` API (`chatCompletion` method).
        *   Exported `ChatMessage` and `InitializationCallbacks` types.
    *   Moved WebLLM model ID (`WEBLLM_CHAT_MODEL_ID`) to `src/siteConfig.ts`.
*   **`ragController.ts` (Task 8 - In Progress):**
    *   Created `src/lib/ragController.ts` with constructor, `processQuery`, and private methods.
    *   Integrated `RAGController` into `ExpandableChatWidget.astro` (instantiation, client-side imports).
    *   Implemented passing `currentDistrictId` from widget to `processQuery` and down to `_cypherToContext`.
    *   Implemented `_textToCypher` using `webllmHandler.chatCompletion` and a detailed prompt including KuzuDB schema.
        *   Updated schema description (`KUZUDB_SCHEMA_DESCRIPTION`) to include `District` and `School` nodes based on project JSON files.
    *   Implemented `_cypherToContext` using `kuzuHandler.executeQuery` and added logic to format single/multiple results into a readable context string.
    *   `_contextToAnswer` uses `webllmHandler.chatCompletion` with basic prompt.
*   **Backend KuzuDB Generation Pipeline (New Task 8.5):**
    *   Added `kuzu` Node.js client dev dependency.
    *   Created `pipeline/scripts/generateKuzuDB.ts` script to:
        *   Define schema (District, School, BELONGS_TO).
        *   Read `districts.json` and `schools_by_district.json`.
        *   Create/overwrite `public/kuzu_dbs/main_data.db`.
        *   Insert data into KuzuDB using the Node.js client.
    *   Integrated script into `package.json` (`build:kuzu`, `prepare`, `clean` scripts).
*   **Fixes:** Resolved various runtime errors (`ReferenceError`) and linter issues related to imports, types, method calls, and null checks across components and libraries.

---

**Step-by-Step Implementation Tasks:**

**Phase 1: Core Component Setup & RAG Service Access Strategy**

1.  **[x] Task: Create `ExpandableChatWidget.astro` (Initial Shell)**
    *   **File:** `src/components/ExpandableChatWidget.astro`
    *   **Content:** Basic Astro component structure for the fixed widget container and the clickable toggle button.
    *   **Sub-task:** Determine and document strategy for `ExpandableChatWidget.astro` to access shared RAG state/services (e.g., `ragController`, `currentDistrictId`, instances of KuzuDB/WebLLM). (Decision: Direct instantiation in client script, passing district ID).
    *   **Testing:** Manually verify the basic widget toggle button renders.

2.  **[x] Task: Prepare `ChatWindow.astro` for RAG-Powered Embedding**
    *   **File:** `src/components/ChatWindow.astro`
    *   **Action:** Design, review, or refactor `ChatWindow.astro` to:
        *   Be cleanly embeddable within `ExpandableChatWidget.astro`.
        *   Communicate via events and exposed methods (`addMessage`, `enableInput`).
        *   Internally manage and display UI states for loading/errors. (Enhanced loading/ready messages).
        *   Handle user input submission gracefully.
        *   Display user messages and AI responses.
    *   **Testing:** Mock interaction tested and working.

**Phase 2: Widget UI & Basic Interactivity**

3.  **[x] Task: Implement Expand/Collapse UI Logic for Widget Shell**
    *   **File:** `src/components/ExpandableChatWidget.astro`
    *   **Action:** Implement client-side script to toggle visibility of the expanded window area. Manage `aria-expanded` attributes.
    *   **Testing:** Manually test click-to-toggle functionality of the expanded view.

4.  **[x] Task: Style Collapsed & Expanded Widget Shell**
    *   **File:** `src/components/ExpandableChatWidget.astro`, `src/components/ChatWindow.astro` (using plain CSS with global variables)
    *   **Action:** Style the collapsed state (chat toggle button) and the expanded state (window frame, including `ChatWindow` content like header, messages, input area).
    *   **Testing:** Visually inspect styles and animations. Ensure use of global color palette. (Message bubble styling achieved).

5.  **[x] Task: Add Smooth Transitions for Expand/Collapse**
    *   **File:** `src/components/ExpandableChatWidget.astro` (CSS)
    *   **Action:** Implement CSS transitions for a smoother visual effect when the chat window opens and closes.
    *   **Testing:** Visually verify smooth opening and closing animations.

**Phase 2.5: RAG Backend Core Implementation**

6.  **[~] Task: Implement `kuzudbHandler.ts`** (Largely complete, API defined, `isReady` added)
    *   **File:** `src/lib/kuzudbHandler.ts`
    *   **Action:**
        *   Develop logic for loading pre-built KuzuDB `.db` files. (Current implementation relies on `kuzu-wasm` loading based on path passed to `Database` constructor).
        *   Implement KuzuDB instance management (initialization, connection, potentially disposal).
        *   Provide `executeQuery(districtId, query, params)` method.
        *   Implement error handling.
    *   **Dependencies:** KuzuDB-Wasm library.
    *   **Testing:** Basic initialization tested via widget.

7.  **[~] Task: Implement `webllmHandler.ts`** (Core structure complete, types exported)
    *   **File:** `src/lib/webllmHandler.ts`
    *   **Action:**
        *   Develop logic for initializing the WebLLM engine (`MLCEngine`).
        *   Provide `chatCompletion(messages, stream, ...)` interface.
        *   Implement error handling.
        *   Exported necessary types (`ChatMessage`, `InitializationCallbacks`).
    *   **Dependencies:** WebLLM library (`@mlc-ai/web-llm`).
    *   **Testing:** Initialization integrated, response generation used by `ragController`.

8.  **[~] Task: Implement `ragController.ts`** (Core methods partially implemented)
    *   **File:** `src/lib/ragController.ts`
    *   **Action:**
        *   Implemented `processQuery(query, currentDistrictId, progressCallback)`. (Done).
        *   **Step 1 (Text-to-Cypher):** Implemented using `webllmHandler.chatCompletion`. Updated schema description to include District/School nodes. (Done).
        *   **Step 2 (Cypher-to-Context):** Implemented using `kuzuHandler.executeQuery`. Added result formatting logic. (Done).
        *   **Step 3 (Context-to-Answer):** Basic implementation using `webllmHandler.chatCompletion` with context and query. (Prompt engineering may be needed).
    *   **Dependencies:** `kuzudbHandler.ts`, `webllmHandler.ts`.
    *   **Testing:** RAG flow connected but relies on actual KuzuDB data and LLM performance.

8.5 **[+] Task: Implement Backend KuzuDB Generation Pipeline** (New Task Added)
    *   **Files:** `pipeline/scripts/generateKuzuDB.ts`, `package.json`
    *   **Action:**
        *   Added `kuzu` Node.js dev dependency.
        *   Created TypeScript script (`generateKuzuDB.ts`) to read project JSON files (`districts.json`, `schools_by_district.json`) and generate a KuzuDB `.db` file (`public/kuzu_dbs/main_data.db`) with defined schema (District, School, BELONGS_TO).
        *   Integrated script into `package.json` (`build:kuzu`, `prepare`, `clean`).
    *   **Status:** Initial script implemented, needs testing and potentially performance improvements (e.g., streaming for large JSON, using COPY FROM). Assumes Policy/Document data is handled separately or added later.

**Phase 3: RAG Integration & Full `ChatWindow.astro` Functionality**

9.  **[x] Task: Embed RAG-Ready `ChatWindow.astro` & Pass Dependencies/Setup Events**
    *   **File:** `src/components/ExpandableChatWidget.astro`
    *   **Action:** Import and embed `ChatWindow.astro`. Establish communication (event listeners for queries, methods for responses) for RAG interactions.
    *   **Testing:** Verified `ChatWindow.astro` renders correctly and communication flow works.

10. **[~] Task: Implement Core Chat Logic via `ragController`** (Largely complete, relies on RAG results)
    *   **File:** `src/components/ExpandableChatWidget.astro` (handler for chat events).
    *   **Action:**
        *   Calls `ragController.processQuery(...)` passing query and district ID. (Done).
        *   `ChatWindow.astro` displays AI responses and handles RAG states via `progressCallback`. (Done).
        *   Provides visual feedback for RAG stages via callback messages. (Done).
        *   Handles errors reported via callback. (Done).
        *   Refined initialization UI messages. (Done).
    *   **Testing:** Test with the actual RAG pipeline. Verify message display, multi-stage feedback, and error states.

11. **[ ] Task: Verify Dynamic RAG Backend Initialization and Context Switching**
    *   **Files:** Relevant layout/state files, `ExpandableChatWidget.astro`, `ChatWindow.astro`, RAG handlers.
    *   **Action:**
        *   Confirm KuzuDB/WebLLM initialization as per `IMPLEMENTATION.md`.
        *   Ensure correct, district-specific KuzuDB instance (if using per-district DBs instead of one main DB) and its schema are used.
        *   **Implement actual `currentDistrictId` selection logic** (currently placeholder in `ExpandableChatWidget.astro`).
        *   Test chat functionality after changing districts.
    *   **Testing:** Manually switch districts; perform test queries. Monitor console/network.

**Phase 4: Final Touches & System-Wide Testing**

12. **[x] Task: Integrate into Main Layout**
    *   **File:** `src/layouts/BaseLayout.astro`
    *   **Action:** Ensured `<ExpandableChatWidget />` is correctly configured.
    *   **Testing:** Verify widget presence across site pages.

13. **[ ] Task: Ensure Responsiveness**
    *   **Files:** `ExpandableChatWidget.astro`, `ChatWindow.astro`, CSS.
    *   **Action:** Adjust styles for various screen sizes.
    *   **Testing:** Manual viewport testing. Automated UI tests if any.

14. **[ ] Task: Accessibility Review & Enhancements**
    *   **File:** `ExpandableChatWidget.astro`, `ChatWindow.astro`
    *   **Action:** Thorough keyboard navigation review, ARIA attributes, screen reader testing, color contrast.
    *   **Testing:** Manual keyboard/screen reader tests. Automated accessibility checks.

15. **[ ] Task: Full End-to-End RAG and UI Testing**
    *   **Action:** Comprehensive testing covering:
        *   District selection and correct RAG context/schema loading.
        *   Widget UI/UX (expand/collapse, animations, focus).
        *   **Query Complexity & Performance: Test with simple and complex natural language questions. Evaluate Cypher generation quality, answer relevance, and response times. Ensure UI handles delays gracefully.**
        *   **RAG Error Handling: Test scenarios where Text-to-Cypher might fail (ambiguous/complex queries), KuzuDB errors, or LLM answer generation issues.**
        *   UI behavior with long messages, multiple messages.
        *   Cross-browser compatibility.
    *   **Goal:** Ensure a robust, user-friendly, accessible, and functional chat widget with the RAG backend.

---

**Next Steps (Focus Areas):**

1.  **Test & Refine KuzuDB Generation:** Run `pnpm run prepare` (or `build:kuzu`), debug `generateKuzuDB.ts`, ensure `main_data.db` is created correctly in `public/kuzu_dbs/`. Address TODOs (DB closing, performance). Decide if Policy/Document data needs to be included.
2.  **Test RAG Pipeline:** Test the end-to-end flow with actual queries about districts/schools. Debug issues in Cypher generation, KuzuDB querying, context formatting, and final answer generation.
3.  **Implement `currentDistrictId` Selection:** Replace the placeholder `currentDistrictId` in `ExpandableChatWidget.astro` with actual logic based on how the user selects a district on the site.
4.  **Refine `_contextToAnswer` Prompt:** Perform prompt engineering based on test results to improve the quality of answers from the LLM.

---

**General Testing Guidance:**
*   Run `pnpm run test` frequently.
*   Complement with manual testing for UI, UX, and RAG functionality, especially considering in-browser LLM performance variations.
*   Use browser developer tools extensively.

---

**Phase X: Potential Enhancements & Long-Term Considerations (Post-MVP)**

*   **State Management Reactivity (Astro Specific):**
    *   If using a global state store (e.g., `src/lib/state.ts`), thoroughly review and test how Astro components (`ExpandableChatWidget.astro`, `ChatWindow.astro`) subscribe to and react to changes in shared state (e.g., `currentDistrictId`, RAG service readiness, KuzuDB/WebLLM instances). Given Astro's island architecture, ensure client-side scripts handle external state updates correctly to re-render or update behavior as needed.

*   **User Input Sanitization:**
    *   While Astro provides some XSS protection by default, if user messages are ever directly rendered as HTML (e.g., if future features allow markdown or rich text from users), ensure robust input sanitization is implemented to prevent XSS vulnerabilities.

*   **Chat History Management (UX):**
    *   Consider adding a client-side feature to allow users to clear the current session's chat history within the `ChatWindow.astro` component. (Note: PRD specifies no saving history across browser sessions).

*   **Resource Management for KuzuDB/WebLLM Instances:**
    *   Investigate and confirm if explicit cleanup or disposal operations are needed for KuzuDB instances or the WebLLM engine when the chat widget is closed for a long time, the user navigates to a completely different section of the site, or the browser tab is closed. This might involve adding `dispose()` methods to `kuzudbHandler.ts` and `webllmHandler.ts` to be called appropriately by the client-side logic managing these instances to free up browser memory and resources if they are not automatically reclaimed efficiently by the WebAssembly environment upon loss of reference.

*   **Scalability of Pre-built DBs & Manifest:**
    *   While primarily a backend pipeline concern (`IMPLEMENTATION.md`, Phase 2.6), monitor the total number and size of pre-built KuzuDB `.db` files and the `manifest.json`. If the number of districts grows exceptionally large, the size of `manifest.json` could impact initial load time or client-side processing. This might necessitate future optimizations in how the manifest is structured or loaded, potentially impacting the widget's data source lookup for the selected district.

*   **Advanced RAG UI Feedback:**
    *   Explore more granular UI feedback for the different stages of the RAG process (Text-to-Cypher, KuzuDB query execution, LLM answer synthesis) if the `ragController` can provide such state updates. This could enhance user perception of system activity during processing.

*   **Optimizing Perceived Performance for In-Browser LLMs:**
    *   Continuously evaluate strategies to improve the perceived performance of the in-browser LLM, such as progressive display of generated text (streaming), or optimizing prompts for faster Cypher generation and answer synthesis, as highlighted in the KuzuDB blog on in-browser RAG. 